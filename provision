#!/usr/bin/env ruby

require "net/ssh"

`touch .env`
require "kamal"

destination = ARGV[0] if ARGV[0].to_s != ""
config_file = Pathname.new(File.expand_path("config/deploy.yml"))
config = Kamal::Configuration.create_from(config_file: config_file, destination: destination)
hosts = config.roles.map(&:hosts).flatten + config.accessories.map(&:hosts).flatten
hosts.uniq!

allow_longer_connections = <<~EOF
  sed -i 's@#ClientAliveInterval 0@ClientAliveInterval 60@g' /etc/ssh/sshd_config
  sed -i 's@#ClientAliveCountMax 3@ClientAliveCountMax 10@g' /etc/ssh/sshd_config
  systemctl restart ssh
EOF

update_system = <<~EOF
  apt update
  DEBIAN_FRONTEND=noninteractive apt upgrade -y
EOF

install_essentials = <<~EOF
  apt install -y docker.io curl unattended-upgrades
EOF

prepare_storage = <<~EOF
  mkdir -p /var/lib/docker/volumes/saas_template_storage/_data
  chmod 700 /var/lib/docker/volumes/saas_template_storage/_data
  chown 1000:1000 /var/lib/docker/volumes/saas_template_storage/_data
EOF

add_swap = <<~EOF
  if [ ! -f /swapfile ]; then
    fallocate -l 2G /swapfile
    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile
    echo '/swapfile swap swap defaults 0 0' >> /etc/fstab
    sysctl vm.swappiness=20
    echo 'vm.swappiness=20' >> /etc/sysctl.conf
  fi
EOF

install_fail2ban = <<~EOF
  apt install -y fail2ban
  systemctl start fail2ban
  systemctl enable fail2ban
EOF

configure_firewall = <<~EOF
  ufw logging on
  ufw default deny incoming
  ufw default allow outgoing
  ufw allow 22
  ufw allow 80
  ufw allow 443
  ufw --force enable
  systemctl restart ufw
EOF

configure_updates = <<~EOF
  cat > /etc/apt/apt.conf.d/20auto-upgrades << 'CONF'
  APT::Periodic::Update-Package-Lists "1";
  APT::Periodic::Unattended-Upgrade "1";
  CONF
  systemctl restart unattended-upgrades
EOF

hosts.each do |host|
  puts "Provisioning server '#{host}'..."
  Net::SSH.start(host, "root") do |ssh|
    puts "Configuring SSH keep-alive..."
    ssh.exec!(allow_longer_connections)
    puts "Updating system..."
    ssh.exec!(update_system)
    puts "Installing essential packages..."
    ssh.exec!(install_essentials)
    puts "Adding swap space..."
    ssh.exec!(add_swap)
    puts "Preparing storage for SQLite..."
    ssh.exec!(prepare_storage)
    puts "Installing fail2ban..."
    ssh.exec!(install_fail2ban)
    puts "Configuring firewall..."
    ssh.exec!(configure_firewall)
    puts "Configuring unattended upgrades..."
    ssh.exec!(configure_updates)
  end
end

puts "Done!"
puts "Server(s) provisioned: #{hosts.join(', ')}"
